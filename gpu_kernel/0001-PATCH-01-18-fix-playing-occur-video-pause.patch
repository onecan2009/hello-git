From dfc1f1907f87fd145e4774b5027f88c98cceee0c Mon Sep 17 00:00:00 2001
From: cjp <service@t-firefly.com>
Date: Thu, 17 Nov 2016 15:57:36 +0800
Subject: [PATCH 01/11] [PATCH 01/18] fix playing occur video pause

---
 drivers/video/rockchip/rk_fb_box.c |   15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/drivers/video/rockchip/rk_fb_box.c b/drivers/video/rockchip/rk_fb_box.c
index fdd26cf..7fb0e8f 100755
--- a/drivers/video/rockchip/rk_fb_box.c
+++ b/drivers/video/rockchip/rk_fb_box.c
@@ -661,7 +661,7 @@ struct device *rk_fb_get_sysmmu_device_by_compatible(const char *compt)
 
         return ret;
 }
-
+
 #ifdef CONFIG_IOMMU_API
 void rk_fb_platform_set_sysmmu(struct device *sysmmu, struct device *dev)
 {
@@ -1180,13 +1180,14 @@ static void rk_fb_update_regs_handler(struct kthread_work *work)
 	saved_list = dev_drv->update_regs_list;
 	list_replace_init(&dev_drv->update_regs_list, &saved_list);
 	mutex_unlock(&dev_drv->update_regs_list_lock);
-	
+	mutex_lock(&dev_drv->win_config);
 	list_for_each_entry_safe(data, next, &saved_list, list) {
 		rk_fb_update_reg(dev_drv,data);
 		list_del(&data->list);
 		kfree(data);
 	}
 
+    mutex_unlock(&dev_drv->win_config);
 	if (dev_drv->wait_fs && list_empty(&dev_drv->update_regs_list))
 		wake_up(&dev_drv->update_regs_wait);
 }
@@ -1476,7 +1477,8 @@ static int rk_fb_set_win_config(struct fb_info *info,
 	regs->post_cfg.xsize = win_data->post_cfg.xsize;
 	regs->post_cfg.ysize = win_data->post_cfg.xsize;
 */
-
+    dev_drv->lcdc_win_num = 2;
+  	mutex_lock(&dev_drv->win_config);
 	for (i = 0; i < dev_drv->lcdc_win_num; i++) {
 		if (win_data->win_par[i].win_id < dev_drv->lcdc_win_num) {
 			rk_fb_set_win_buffer(info, &win_data->win_par[i],
@@ -1493,7 +1495,7 @@ static int rk_fb_set_win_config(struct fb_info *info,
 			       win_data->win_par[i].win_id);
 		}
 	}
-
+    mutex_unlock(&dev_drv->win_config);
 	mutex_lock(&dev_drv->output_lock);
 	if (!(dev_drv->suspend_flag == 0)) {
 		rk_fb_update_reg(dev_drv, regs);
@@ -1832,7 +1834,10 @@ static int rk_fb_ioctl(struct fb_info *info, unsigned int cmd,
 		};
 
 		dev_drv->wait_fs = win_data.wait_fs;
-		rk_fb_set_win_config(info,&win_data);	
+		if (rk_fb_set_win_config(info,&win_data)) {
+			pr_info("config done error\n");
+			return -EFAULT;
+		}	
 
 		if (copy_to_user((struct rk_fb_win_cfg_data __user *)arg,
 				 &win_data, sizeof(win_data))) {
-- 
1.7.9.5

